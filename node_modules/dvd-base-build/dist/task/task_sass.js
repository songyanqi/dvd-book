'use strict';

var _gulp = require('gulp');

var _gulp2 = _interopRequireDefault(_gulp);

var _gulpSass = require('gulp-sass');

var _gulpSass2 = _interopRequireDefault(_gulpSass);

var _gulpSize = require('gulp-size');

var _gulpSize2 = _interopRequireDefault(_gulpSize);

var _swgGulpRev = require('swg-gulp-rev');

var _swgGulpRev2 = _interopRequireDefault(_swgGulpRev);

var _gulpAddSrc = require('gulp-add-src');

var _gulpAddSrc2 = _interopRequireDefault(_gulpAddSrc);

var _gulpReplace = require('gulp-replace');

var _gulpReplace2 = _interopRequireDefault(_gulpReplace);

var _gulpMinifyCss = require('gulp-minify-css');

var _gulpMinifyCss2 = _interopRequireDefault(_gulpMinifyCss);

var _gulpSourcemaps = require('gulp-sourcemaps');

var _gulpSourcemaps2 = _interopRequireDefault(_gulpSourcemaps);

var _gulpAutoprefixer = require('gulp-autoprefixer');

var _gulpAutoprefixer2 = _interopRequireDefault(_gulpAutoprefixer);

var _swgGulpRevCollector = require('swg-gulp-rev-collector');

var _swgGulpRevCollector2 = _interopRequireDefault(_swgGulpRevCollector);

var _util = require('../util.js');

var _util2 = _interopRequireDefault(_util);

var _config = require('../config.js');

var _config2 = _interopRequireDefault(_config);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/************************************ 编译SASS ************************************/


// 自定义
// 第三方
_gulp2.default.task('task_sass', function () {
  console.log('>>>>>>>>>>>>>>> sass\u6587\u4EF6\u5F00\u59CB\u7F16\u8BD1\u3002' + _util2.default.getNow());

  return _gulp2.default.src(_config2.default.path.css)

  // sass转css
  .pipe(_gulpSourcemaps2.default.init()).pipe((0, _gulpSass2.default)({
    outputStyle: 'uncompressed'
  })).pipe(_gulpSourcemaps2.default.write({
    includeContent: false
  }))

  // 替换全局环境变量
  .pipe((0, _gulpReplace2.default)(_config2.default.replacer.regex, function (match) {
    return _config2.default.replacer[match];
  }))

  // 替换css中img的md5版本号
  .pipe(_config2.default.env.mini ? (0, _gulpAddSrc2.default)(_config2.default.path.temp + '/rev-md5/img.json') : _util2.default.gulpNothing()).pipe(_config2.default.env.mini ? (0, _swgGulpRevCollector2.default)() : _util2.default.gulpNothing())

  // 添加css前缀
  .pipe((0, _gulpAutoprefixer2.default)(_config2.default.autoprefixer))

  // css压缩混淆
  .pipe(_config2.default.env.mini ? (0, _gulpMinifyCss2.default)() : _util2.default.gulpNothing())

  // 显示编译后css文件体积
  .pipe((0, _gulpSize2.default)({ showFiles: true }))

  // 收集css文件的MD5值
  .pipe(_config2.default.env.mini ? (0, _swgGulpRev2.default)() : _util2.default.gulpNothing())

  // 输出css文件
  .pipe(_gulp2.default.dest(_config2.default.path.static))

  // 输出css文件与MD5值匹配关系的文件
  .pipe(_config2.default.env.mini ? _swgGulpRev2.default.manifest('rev-md5/css.json') : _util2.default.gulpNothing()).pipe(_config2.default.env.mini ? _gulp2.default.dest(_config2.default.path.temp) : _util2.default.gulpNothing());
});