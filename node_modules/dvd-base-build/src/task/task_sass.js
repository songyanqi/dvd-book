// 第三方
import gulp from 'gulp';
import sass from 'gulp-sass';
import size from 'gulp-size';
import rev from 'swg-gulp-rev';
import addSrc from 'gulp-add-src';
import replace from 'gulp-replace';
import minifyCss from 'gulp-minify-css';
import sourcemaps from 'gulp-sourcemaps';
import autoprefixer from 'gulp-autoprefixer';
import revCollector from 'swg-gulp-rev-collector';

// 自定义
import util from '../util.js';
import config from '../config.js';

/************************************ 编译SASS ************************************/
gulp.task('task_sass', () => {
  console.log(`>>>>>>>>>>>>>>> sass文件开始编译。${util.getNow()}`);

  return gulp.src(config.path.css)

    // sass转css
    .pipe(sourcemaps.init())
    .pipe(sass({
      outputStyle: 'uncompressed',
    }))
    .pipe(sourcemaps.write({
      includeContent: false,
    }))

    // 替换全局环境变量
    .pipe(replace(config.replacer.regex, function (match) {
      return config.replacer[match];
    }))

    // 替换css中img的md5版本号
    .pipe(config.env.mini ? addSrc(`${config.path.temp}/rev-md5/img.json`) : util.gulpNothing())
    .pipe(config.env.mini ? revCollector() : util.gulpNothing())

    // 添加css前缀
    .pipe(autoprefixer(config.autoprefixer))

    // css压缩混淆
    .pipe(config.env.mini ? minifyCss() : util.gulpNothing())

    // 显示编译后css文件体积
    .pipe(size({showFiles: true}))

    // 收集css文件的MD5值
    .pipe(config.env.mini ? rev() : util.gulpNothing())

    // 输出css文件
    .pipe(gulp.dest(config.path.static))

    // 输出css文件与MD5值匹配关系的文件
    .pipe(config.env.mini ? rev.manifest('rev-md5/css.json') : util.gulpNothing())
    .pipe(config.env.mini ? gulp.dest(config.path.temp) : util.gulpNothing())
    ;
});
