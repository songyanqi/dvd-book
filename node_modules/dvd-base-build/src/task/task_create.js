// 第三方
import fs from 'fs';
import gulp from 'gulp';
import inquirer from 'inquirer';
import rename from 'gulp-rename';
import replace from 'gulp-replace';

// 自定义
import util from '../util.js';

/************************************ 创建新模块(npm run create) ************************************/
gulp.task('task_create', () => {
  console.log(`>>>>>>>>>>>>>>> 开始创建新页面。${util.getNow()}`);

  // 询问用户新页面信息
  inquirer.prompt([
    {
      type: 'list',
      name: 'type',
      message: 'please input page\'s type ?',
      choices: [
        'mpa',
        'spa',
      ],
      validate: function (input) {
        return input ? true : false;
      }
    },
    {
      type: 'input',
      name: 'name',
      message: 'please input page\'s name ?',
      validate: function (input) {
        return input ? true : false;
      }
    },
    {
      type: 'input',
      name: 'title',
      message: 'please input page\'s title ?'
    }
  ]).then((answer) => {
    console.log(JSON.stringify(answer, ' ', 2));

    // 模板文件路径
    let tplFilePath = `node_modules/dvd-base-build/creator/${answer.type}/**/*.*`;

    // 生成文件路径
    let destFilePath = `src/page/${answer.name}`;

    // 开始生成文件
    gulp.src(tplFilePath)
      // 统一文件名称
      .pipe(rename({
        basename: answer.name
      }))

      // 替换变量
      .pipe(replace('{{name}}', answer.name))
      .pipe(replace('${{title}}', answer.title || ''))

      // 输出文件
      .pipe(gulp.dest(destFilePath))

      // 生成空目录
      .on('end', function () {
        setTimeout(function () {
          fs.mkdirSync(destFilePath + '/img');
          fs.mkdirSync(destFilePath + '/vue');
        }, 1000);
      })
    ;

    console.log(`>>>>>>>>>>>>>>> ${answer.type}: ${answer.name}页面已创建完毕。${util.getNow()}`);
  });
});
