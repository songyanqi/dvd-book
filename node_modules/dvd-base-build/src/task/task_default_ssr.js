// 第三方
import gulp from 'gulp';
import runSequence from 'run-sequence';
import liveReload from 'gulp-livereload';

// 自定义
import util from '../util.js';
import config from '../config.js';

require('./task_js_ssr.js');
gulp.task('default', () => {
  // 打印发布版本
  console.log(`~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~发布ssr~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~`);

  // 按顺序编译
  return runSequence(
    ['task_js_ssr'],
    function () {
      // 打印发布版本
      console.log(`~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ssr发布完毕(全部编译&&压缩)~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~`);

      // 文件变化回调函数
      let changeCallback = (event) => {
        console.log(`检测到${event.path}文件发生改变，开始执行任务...`);
      };

      // 更新静态资源时间戳
      config.replacer['[[v]]'] = `?v=${util.getTimeFormatVersion()}`;

      let watchDir = `{src,node_modules/dvd-*,module,stylesheet,utils}/**`;

      // 监视js,vue,json变化，触发js编译
      gulp.watch(`${watchDir}/!*.{js,vue,json${config.pkg.name == 'm' ? ',es6' : ''}}`, ['task_js_ssr']).on('change', changeCallback);

      console.log(`>>>>>>>>>>>>>>> gulp开始监听{src,node_modules/dvd-*}目录文件变化...${util.getNow()}`);


      require('./server.js');
    }
  );
});
