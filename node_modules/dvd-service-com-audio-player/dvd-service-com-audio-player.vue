<!--大V店公用音频播放器组件-->
<template>
  <div class="dvd-service-com-audio-player">
    <!--进度条-->
    <div class="progress-bar" ref="progress_bar">
      <div class="bar" @click="barClick">
        <div class="readed" :style="{width: progress + '%'}"></div>
        <div class="pointer" :style="{marginLeft: progress + '%'}"
             @touchstart="touchstart" @touchmove="touchmove" @touchend="touchend">
        </div>
      </div>
    </div>
    <!--进度信息-->
    <div class="progress-info">
      <span class="current-time">{{currentTimeInfo.minute}}:{{currentTimeInfo.second}}</span>
      <span class="space"></span>
      <span class="total-time">{{totalTimeInfo.minute}}:{{totalTimeInfo.second}}</span>
    </div>
  </div>
</template>

<script>
  import ua from 'dvd-base-js-ua';
  import date from 'dvd-base-js-date';
  import util from 'dvd-service-js-util';
  import number from 'dvd-base-js-number';
  import login from 'dvd-service-js-login';
  import share from 'dvd-service-js-share';
  import native from 'dvd-service-js-native';

  export default {
    props: {
      // 播放列表
      playList: {
        type: Array,
        default: [
          /*'http://media.davdian.com/contentAudio/201712264369/15142590913795.mp3',
           'http://media.davdian.com/contentAudio/201712262507/15142587453123.mp3',
           'http://media.davdian.com/contentAudio/201712254810/15141898237708.mp3',*/
        ],
      },
      // 播放索引
      playIndex: {
        type: Number,
        default: 0,
      },
      // 是否循环播放
      loop: {
        type: Boolean,
        default: false,
      },
    },
    data() {
      return {
        // 全局变量
        window,
        document,
        location,

        // 工具模块
        ua,
        native,
        login,
        share,
        number,
        date,

        // 音频属性
        audio: new Audio(),
        duration: 0,
        currentTime: 0,
        isPlaying: false,
        isDragging: false,

        // 秒级检查器，持续检查&&设置播放器各项状态
        checker: null,

        // 拖动属性
        startX: null,
        startTime: null,
        progressBarClientX: null,
        progressBarClientWidth: null,
      }
    },
    computed: {
      // 播放百分比
      progress() {
        return this.getSafeCurrentTime() / this.duration * 100 || 0;
      },
      // 音频当前播放信息
      currentTimeInfo() {
        return date.getTimeDuration({
          second: this.currentTime,
          digit: 2,
        });
      },
      // 音频时长信息
      totalTimeInfo() {
        return date.getTimeDuration({
          second: this.duration,
          digit: 2,
        });
      },
    },
    created() {
      let ts = this;

      // 立即加载音频
      this.audio.preload = 'auto';

      // 加载指定音频，默认为第一首
      if (this.playList[this.playIndex]) {
        this.audio.src = this.playList[this.playIndex];
      }

      // 秒级检查器，持续检查&&设置播放器各项状态
      ts.checker = setInterval(ts.check, 1000);
    },
    mounted() {
      // 获取进度条左侧距离和宽度
      this.progressBarClientX = util.getOffsetLeft(this.$refs.progress_bar);
      this.progressBarClientWidth = this.$refs.progress_bar.clientWidth;
    },
    beforeDestroy() {
      let ts = this;

      // 销毁音频
      ts.audio.pause();
      ts.audio = null;

      // 销毁秒级检查器
      clearInterval(ts.checker);
      ts.checker = null;
    },
    methods: {
      // 检查&&设置播放器各项状态
      check() {
        // 获取音频信息
        this.duration = this.audio.duration || 0;
        this.currentTime = this.audio.currentTime || 0;

        // 如果正在拖动，只进行上面的状态读取，不进行下面的音频操作
        if (this.isDragging) return;

        // 如果当前音频播放结束
        if (this.audio.ended) {
          // 如果是最后一首
          if (this.playIndex === this.playList.length - 1) {
            // 如果循环播放
            if (this.loop) {
              // 重置为第一首
              this.playIndex = 0;
              // 如果不是循环播放
            } else {
              // 状态设置为停止播放
              this.isPlaying = false;
            }
            // 如果不是最后一首
          } else {
            // 播放序号+1
            this.playIndex += 1;
          }
          // 广播事件
          this.emitChange();
        }

        // 如果状态为正在播放，则继续播放
        this.isPlaying && this.play();
      },
      // 播放音频
      play(playIndex) {
        // 如果给了音频序号并且序号符合范围，则播放指定序号的音频
        if (playIndex !== undefined && this.playList[playIndex]) {
          this.playIndex = playIndex;
        }

        // 如果当前播放音频地址与应播放的音频地址不一致，则变更为应播放音频地址
        let src = this.playList[this.playIndex];
        if (this.audio.src !== src) {
          this.audio.src = src;
        }

        // 播放
        this.audio.play();
        this.isPlaying = true;

        // 广播事件
        this.emitChange();
      },
      // 暂停音频
      pause() {
        this.audio.pause();
        this.isPlaying = false;

        // 广播事件
        this.emitChange();
      },
      // 上一首
      prev() {
        // 变更当前播放索引，最小为第一首
        if (this.playIndex > 0) {
          this.playIndex -= 1;
        } else {
          this.playIndex = 0;
        }

        /*// 如果当前状态正在播放，则立即播放
         if (this.isPlaying) {
         this.audio.play();
         }*/

        // 立即播放
        this.play();

        // 广播事件
        this.emitPrev();
        this.emitChange();
      },
      // 下一首
      next() {
        // 变更当前播放索引，最大为最后一首
        if (this.playIndex < this.playList.length - 1) {
          this.playIndex += 1;
        } else {
          this.playIndex = this.playList.length - 1;
        }

        /*// 如果当前状态正在播放，则立即播放
         if (this.isPlaying) {
         this.audio.play();
         }*/

        // 立即播放
        this.play();

        // 广播事件
        this.emitNext();
        this.emitChange();
      },
      // 广播上一首事件
      emitPrev() {
        this.$emit('next', {
          playIndex: this.playIndex,
          isPlaying: this.isPlaying,
        });
      },
      // 广播下一首事件
      emitNext() {
        this.$emit('next',{
          playIndex: this.playIndex,
          isPlaying: this.isPlaying,
        });
      },
      // 广播音频变更事件
      emitChange() {
        this.$emit('change', {
          playIndex: this.playIndex,
          isPlaying: this.isPlaying,
        });
      },
      // 进度条拖动开始回调
      touchstart(event) {
        this.startX = event.changedTouches[0].clientX;
        this.startTime = this.currentTime;
        this.isDragging = true;
      },
      // 进度条拖动持续回调
      touchmove(event) {
        /*// 移动像素
         let moveX = event.changedTouches[0].clientX - this.startX;

         // 移动百分比
         let moveRatio = moveX / this.$refs.progress_bar.clientWidth;

         // 偏移时间
         let moveTime = this.duration * moveRatio;

         // 拖动后的当前时间
         let currentTime = this.getSafeCurrentTime(this.startTime + moveTime);

         // 设置当前时间
         this.currentTime = currentTime;

         // 播放当前时间
         this.audio.currentTime = currentTime;

         // 检查状态
         this.check();*/

        this.play();
        this.setProgress(event.changedTouches[0].clientX);
      },
      // 进度条拖动结束回调
      touchend(event) {
        this.startX = null;
        this.isDragging = false;
      },
      // 进度条点击回调
      barClick(event) {
        this.play();
        this.setProgress(event.clientX);
      },
      // 根据X坐标设置播放进度
      setProgress(clientX) {
        // 进度条像素位置
        let progressX = clientX - this.progressBarClientX;

        // 进度条像素比
        let progressRatio = progressX / this.progressBarClientWidth;

        // 拖动后的当前时间
        let currentTime = this.getSafeCurrentTime(progressRatio * this.duration);

        // 设置当前时间
        this.currentTime = currentTime;

        // 播放当前时间
        this.audio.currentTime = currentTime;

        // 检查状态
        this.check();
      },
      // 获取在安全范围内的当前播放时间
      getSafeCurrentTime(currentTime) {
        // 不传则取当前播放器的currentTime
        currentTime = currentTime || this.currentTime;
        // 安全检测
        if (currentTime < 1 /* 因为currentTime小于1时仍然会显示'00:00' */) {
          return 0;
        } else if (currentTime >= this.duration) {
          return this.duration;
        } else {
          return currentTime;
        }
      },
    },
    filters: {},
    watch: {},
  }
</script>

<style lang="sass" lang="scss" rel="stylesheet/scss">
  @import "../dvd-base-scss-util/dvd-base-scss-util";

  $pointer-radius: r(14);
  $bar-height: r(4);

  // 顶部标题
  .dvd-service-com-audio-player {
    // 进度条
    .progress-bar {
      padding: ($pointer-radius - $bar-height / 2) 0;
      .bar {
        position: relative;
        height: $bar-height;
        background: #ECECEC;
        border-radius: r(100);
        overflow: visible;
        .readed {
          height: $bar-height;
          background: #FF613C;
        }
        .pointer {
          position: absolute;
          top: $bar-height / 2 - $pointer-radius;
          left: - $pointer-radius;
          @include circle($pointer-radius * 2);
          /*background: #FF4a7d;*/
          background: url(./img/progress-bar-point.png);
          background-size: 100%;
          &:after {
            $radius: $pointer-radius * 2;
            content: '';
            @include circle($radius * 2);
            position: relative;
            left: $pointer-radius - $radius;
            top: $pointer-radius - $radius;
            /*background: green;*/
            /*opacity: 0.5;*/
          }
        }
      }
    }
    // 进度信息
    .progress-info {
      margin-top: r(10);
      display: flex;
      font-size: r(12);
      color: #666;
      text-align: center;
      .current-time {

      }
      // 空出位置，留给以后要添加的内容
      .space {
        flex: 1;
      }
      .total-time {

      }
    }
  }
</style>
